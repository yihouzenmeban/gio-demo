"use strict";if(!gioGlobal.__growing__)throw"未加载 gio SDK";const gio=gioGlobal.__growing__.gio,growingio=gioGlobal.__growing__.growingio,gioEmitter=gioGlobal.__growing__.gioEmitter,userStorage=gioGlobal.__growing__.userStorage,baseUrl="https://messages.growingio.com/v3";if(!growingio.info)throw"gio SDK 未初始化";const format=e=>"boolean"==typeof e?e:"string"==typeof e?"t"===e:void 0,parseBoolExpr=function(e){if("t"===e)return!0;if("f"===e)return!1;e="("+e.replace(/\&+/g,"&").replace(/\|+/g,"|")+")";const t=[];for(let s=0;e.length>s;s++){let i,r;t.push(e[s]);let a=[];for(;")"===e[s]&&"("!==i&&void 0!==(i=t.pop());)["&","|"].includes(i)?r=i:["t","f",!0,!1].includes(i)&&a.push(i);if(r&&a.length){const e=a.reduce((e,t)=>{const s=format(e),i=format(t);return"&"===r?s&&i:"|"===r?s||i:void 0},format(a[0]));t.push(e)}}return t.pop()};class StatusStorage{constructor(e){this.namespace=e}_getOldkey(e){return"#"+this.namespace+"#"+e}_key(e,t=""){return"#"+this.namespace+"#"+e+"_"+t}_get(e,t){const s=this._getOldkey(e),i=growingio.info.getStorageSync(s);if(i)return growingio.info.removeStorageSync(s),JSON.parse(i);const r=growingio.info.getStorageSync(this._key(e,t));return!!r&&JSON.parse(r)}_set(e,t,s){growingio.info.setStorageSync(this._key(e,t),s)}get(e,t){const s=this._get(e,t),i={showTimes:0,showDate:Date.now()};if(s){const r={...i,...s};return this._set(e,t,r),r}return this._set(e,t,i),i}plus(e,t,s,i){const r=this.get(e,t);r[s]=r[s]+i,this._set(e,t,r)}plusShowTimes(e,t,s){this.plus(e,t,"showTimes",s)}plusShowDate(e,t,s){const i=this.get(e,t),r=new Date(Date.now()+s);r.setHours(0),r.setMinutes(0),r.setSeconds(0),i.showDate=r.getTime(),this._set(e,t,i)}}class Marketing{constructor(){console.log("Marketing 引入成功。请继续使用<gio-marketing />集成在您需要的页面中."),this.isInit=!1,this.statusStorage=new StatusStorage("push-status"),this.timer=null,this.isPreview=!1,this.isRequested=!1,this.isDispatching=!1,this.listener=null,this.fetchedMessages=[],this.renderQueue=[],this.unResolvedEvents=[],this.handleCs1Refresh=this.handleCs1Refresh.bind(this),this.handleEvent=this.handleEvent.bind(this),this.addGlobalEventListener()}static getInstance(){return this.marketing||(this.marketing=new Marketing),this.marketing}init(){this.destroy(),console.log("gio-marketing 集成成功！初始化中…"),this.isInit=!0,this.addEventListener()}update(){this.refetchPushMessage()}disabled(){this.resetState(),this.setPreviewState(!1)}destroy(){this.disabled(),this.isInit=!1,this.removeEventListener()}addGlobalEventListener(){gioEmitter.on("cs1Refresh",this.handleCs1Refresh)}addEventListener(){gioEmitter.on("appOpen",this.handleEvent),gioEmitter.on("upload",this.handleEvent)}removeEventListener(){gioEmitter.off("appOpen",this.handleEvent),gioEmitter.off("upload",this.handleEvent)}addComponentListener(e){this.listener=e}removeComponentListener(){this.listener=null}resetState(){this.timer=null,this.isRequested=!1,this.isDispatching=!1,this.renderQueue=[],this.clearFetchedMessages(),this.clearUnResolvedEvents()}getPreviewState(){return this.isPreview}setPreviewState(e){this.isPreview=e}gatherUnResolvedEvents(e){this.unResolvedEvents.push(e)}clearUnResolvedEvents(){this.unResolvedEvents=[]}clearFetchedMessages(){this.fetchedMessages=[]}formatUrl(){const e={bu:userStorage.get("bu"),bcs:userStorage.get("bcs"),u:growingio.info.uid,cs:gio("getUserId")};let t=`${baseUrl}/${growingio.vdsConfig.projectId}/notifications?url_scheme=${growingio.vdsConfig.appId}`;return Object.keys(e).forEach(s=>{const i=e[s];i&&(t+=`&${s}=${i}`)}),t}fetchPushMessage(){const e=this.formatUrl(),t=Date.now();growingio.info.request({url:e,header:{"X-Timezone":(""+new Date).match(/GMT\+[0-9]+/g)[0]},success:e=>{const s=Date.now();if(this.updateUserStorage(e),!this.getPreviewState()){if(e.data.previewStatus)return this.setPreviewState(!0),void this.fetchPreviewPushMessage(e.data.previewStatus.messageId,e.data.previewStatus.messageType);this.setPreviewState(!1),this.setFetchedMessages(e.data.popupWindows),s-t>5e3&&this.clearUnResolvedEvents(),this.consumeUnResolvedEvents()}},fail:()=>{this.getPreviewState()||this.clearUnResolvedEvents()},complete:()=>{this.getPreviewState()||(this.isRequested=!0)}})}fetchPreviewPushMessage(e,t){const s=Date.now();growingio.info.request({url:`${baseUrl}/${growingio.vdsConfig.projectId}/notifications/preview?url_scheme=${growingio.vdsConfig.appId}&message_id=${e}&msgType=${t}`,success:e=>{const t=Date.now();this.setFetchedMessages(e.data.popupWindows),t-s>5e3&&this.clearUnResolvedEvents(),this.consumeUnResolvedEvents()},fail:()=>{this.clearUnResolvedEvents()},complete:()=>{this.isRequested=!0}})}updateUserStorage(e){e&&e.data&&e.data.idMappings&&(userStorage.set("bcs",e.data.idMappings.bcs),userStorage.set("bu",e.data.idMappings.bu))}setFetchedMessages(e=[],t=!0){t&&(this.fetchedMessages=e.sort((e,t)=>t.updateAt-e.updateAt))}refetchPushMessage(){this.getPreviewState()||(this.isRequested=!1,this.clearFetchedMessages(),this.fetchPushMessage(),this.timer=setTimeout(()=>{this.refetchPushMessage()},18e5))}consumeUnResolvedEvents(e){const t=e=>{if("cstm"===e.t&&!e.n.startsWith("in_app_message_")){const t=this.getValidMessage(e,this.fetchedMessages);t&&(void 0!==t.rule.triggerDelay?setTimeout(()=>{s(t)},1e3*t.rule.triggerDelay):s(t))}},s=e=>{this.renderQueue.push(e),this.dispatchMessage()};if(e)t(e);else for(;this.unResolvedEvents.length>0&&this.fetchedMessages.length>0;){t(this.unResolvedEvents.shift())}}consumeNextMessage(){this.isDispatching=!1,this.dispatchMessage()}dispatchMessage(){if(!this.isDispatching){this.isDispatching=!0;const e=this.renderQueue.shift();this.triggerListener(e)}}triggerListener(e){e&&this.listener&&this.listener(e)}getValidMessage(e,t){return t.filter(t=>this.getPreviewState()?this.validPreviewMessages(t,e):this.validOnlineMessages(t,e))[0]}validOnlineMessages(e,t){const s=userStorage.get("cs1");return this.validAbNeedShow(e,t)&&this.validTimeRange(e,t)&&this.validTimes(e,t,s)&&this.validTriggerCd(e,t,s)&&this.validUserFilter(e,t)&&this.validTriggerFilter(e,t)}validPreviewMessages(e,t){return this.validAbNeedShow(e,t)&&this.validTriggerFilter(e,t)}validAbNeedShow(e,t){const s=!(e.abTest&&e.abTest.ctrlGroup);return console.log(`${e.name} validAbNeedShow`,s,t),s}validTimeRange(e,t){const s=Date.now(),i=s>=(e.rule.startAt||0)&&(e.rule.endAt||s+1)>s;return console.log(`${e.name} validTimeRange`,i,t),i}validTimes(e,t,s){const i=this.statusStorage.get(e.id,s).showTimes,r=e.rule.limit>i;return console.log(`${e.name} validTimes`,r,t),r}validTriggerCd(e,t,s){const i=this.statusStorage.get(e.id,s).showDate<Date.now();return console.log(`${e.name} validTriggerCd`,i,t),i}validUserFilter(e,t){let s;if(e.rule.filters&&e.rule.filters.expr&&e.rule.filters.exprs&&e.rule.filters.exprs.length){const t=this.getUserFilterMaps(e.rule.filters.exprs),i=this.getBoolExprs(t,e.rule.filters.expr);s=parseBoolExpr(i)}else s=!0;return console.log(`${e.name} validUserFilter`,s,t),s}validTriggerFilter(e,t){let s;if(e.rule.triggerFilter&&e.rule.triggerFilter.conditionExpr&&e.rule.triggerFilter.conditions&&e.rule.triggerFilter.conditions.length){const i=this.getTriggerFilterMaps(t,e.rule.triggerFilter.conditions),r=this.getBoolExprs(i,e.rule.triggerFilter.conditionExpr);s=parseBoolExpr(r)}else s=!0;return console.log(`${e.name} validTriggerFilter`,s,t),s}mergeUserAttrs(e){let t={};return e.forEach(e=>{t[e.key]=e}),Object.values(t)}getUserFilterMaps(e){const t=this.mergeUserAttrs(userStorage.getUserAttrs());return e.map(e=>({symbol:e.symbol,result:t.some(this.validUserFilterExpression.bind(this,e))?"t":"f"}))}getTriggerFilterMaps(e,t){const s=userStorage.getTriggerAttrs();return t.map(t=>{const i=s.filter(e=>e.key===t.key);return{symbol:t.alias,result:e.n===t.key&&i.length&&this.validTriggerFilterExpression(t,i)?"t":"f"}})}getBoolExprs(e,t){return e.reduce((e,t)=>e.replace(RegExp(t.symbol,"g"),t.result),t)}validUserFilterExpression(e,t){return t.key===e.key&&this.validExpression(t.value,e)}validTriggerFilterExpression(e,t){const s=e.dimFilters||[];return{count:()=>{const i=this.validDimFilters(t,s).length;return this.validExpression(i,e)},sum:()=>{const i=e.attribute;if(!i)return!1;let r=0;if(s.length){const e=this.validDimFilters(t,s);r=this.sumAttribute(e,i)}else r=this.sumAttribute(t,i);return this.validExpression(r,e)}}[e.aggregator]()||!1}validDimFilters(e,t=[]){return t.length?e.filter(e=>{const s=e.event_variable||[];return t.every(e=>s.some(t=>this.validExpression(t.value,e)))}):e}sumAttribute(e,t){let s=0;return e.forEach(e=>{(e.event_variable||[]).forEach(e=>{e.key===t&&(s+=+e.value||0)})}),s}validExpression(e,t){let s=t.values;return"date"===t.valueType&&(s=s.map(this.formatDate),e=this.formatDate(e)),"=="===t.op?e==s[0]:"<"===t.op?s[0]>e:">"===t.op?e>s[0]:"<="===t.op?s[0]>=e:">="===t.op?e>=s[0]:"!="===t.op?e!=s[0]:"between"===t.op?s[1]>=e&&e>=s[0]:"in"===t.op?s.find(t=>t===e):"not in"===t.op&&!s.find(t=>t===e)}formatDate(e){const t=e.substr(0,4),s=e.substr(4,2),i=e.substr(6,2);return new Date(`${t}-${s}-${i}`).getTime()}onTrackImp(e){if(!this.getPreviewState()){const t=userStorage.get("cs1");gio("track","in_app_message_imp",{in_app_message_name:e.name}),this.statusStorage.plusShowTimes(e.id,t,1),this.statusStorage.plusShowDate(e.id,t,1e3*e.rule.triggerCd)}}onCloseWindow(e){this.getPreviewState()||gio("track","in_app_message_close",{in_app_message_name:e.name}),this.consumeNextMessage()}onClickTarget(e){if(!this.getPreviewState()){const t=userStorage.get("cs1");gio("track","in_app_message_cmp_click",{in_app_message_name:e.name}),this.statusStorage.plusShowTimes(e.id,t,5e3)}const t=e.contentMetadata.components[0].config.target[`growing.${growingio.vdsConfig.appId}`];t&&this.navigateTo(t)}navigateTo(e){growingio.info.navigateTo({url:e,fail:()=>{growingio.info.switchTab({url:e})}})}handleCs1Refresh(){this.isInit&&this.refetchPushMessage()}handleEvent(e){if(e)switch(e.t){case"cstm":this.fetchedMessages.length?this.consumeUnResolvedEvents(e):this.isRequested||this.gatherUnResolvedEvents(e);break;case"page":const t=gioGlobal.__growing__.marketingPreview;if(!t)return;this.setPreviewState(!0),this.fetchPreviewPushMessage(t.messageId,t.msgType)}}}const marketing=Marketing.getInstance();Component({data:{message:void 0,visible:!1},attached(){marketing.init(),marketing.addComponentListener(e=>{this.setData({message:e,visible:!0}),marketing.onTrackImp(e)})},detached(){marketing.destroy(),marketing.removeComponentListener(),this.hideModal()},pageLifetimes:{show(){marketing.update(),gioEmitter.emit("appOpen",{t:"cstm",n:"appOpen"})},hide(){marketing.disabled(),this.hideModal()}},methods:{onClickTarget(){this.hideModal(),marketing.onClickTarget(this.data.message)},onImageLoad(){},onImageError(){this.hideModal(),marketing.consumeNextMessage()},handleClose(){this.hideModal(),marketing.onCloseWindow(this.data.message)},handleTouchMove(){},hideModal(){this.setData({visible:!1})}}});
